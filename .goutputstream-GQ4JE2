<?php
session_start();

// Verificar si la sesión del usuario existe y contiene la variable 'username'
if (isset($_SESSION['username']) && isset($_SESSION['id'])) {
    // Obtén el nombre de usuario desde la sesión
    $username = $_SESSION['username'];
    $band_id = $_SESSION['id'];

    $user = 'root';
    $dbpassword = '';
    $dsn = 'mysql:dbname=bands;host=localhost';

    try {
        $dbconn = new PDO($dsn, $user, $dbpassword);

        // Construir la consulta base
        $query = "SELECT * FROM instruments WHERE band_id = :band_id";

        // Verificar si se ha enviado un formulario de búsqueda
        if ($_SERVER['REQUEST_METHOD'] === 'POST' && isset($_POST['search_by']) && isset($_POST['search_term'])) {
            $searchBy = $_POST['search_by'];
            $searchTerm = $_POST['search_term'];

            // Añadir condiciones de búsqueda a la consulta
            $query .= " AND $searchBy LIKE :search_term";

            // Preparar la consulta con la condición de búsqueda
            $statement = $dbconn->prepare($query);
            $statement->bindParam(':search_term', $searchTerm);
        } else {
            // Si no hay búsqueda, usar la consulta sin modificaciones
            $statement = $dbconn->prepare($query);
        }

        $statement->bindParam(':band_id', $band_id);
        $statement->execute();

        // Obtener todas las filas como un array asociativo
        $array = $statement->fetchAll(PDO::FETCH_ASSOC);

    } catch (PDOException $e) {
        $error_message = "Error de conexión a la base de datos: " . $e->getMessage();
    }
} else {
    // Si la sesión no contiene 'username', redirige de nuevo a la página de inicio de sesión
    header("Location: login.php");
    exit();
}
?>

<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tienda de Instrumentos</title>
    <link rel="stylesheet" href="CSS/main_webpage.css">

    <!-- Agregar estilos específicos para resaltar el estado -->
    <style>
        .instrument-status {
            font-weight: bold;
        }

        .available {
            color: lightgreen;
        }

        .lent {
            color: red;
        }
    </style>
</head>

<body>
    <header>
        <h1>Tienda de Instrumentos</h1>
        <h3>Bienvenido,
            <?php echo $username; ?>
        </h3>
    </header>

    <nav>
        <div class="nav-links">
            <div><a href="main_webpage.php">Home</a></div>
            <div><a href="#">Contact</a></div>
            <div><a href="#">Search</a></div>
        </div>
        <div class="menu-links">
            <a href="logout.php">Close session</a>
            <a href="newInstrument.php">Register new instrument</a>
        </div>
    </nav>

    <aside>
        <h2>Search</h2>
        <form action="main_webpage.php" method="POST">
            <label for="search">Search by: </label>
            <select name="search_by">
                <option value="brand">Brand</option>
                <option value="model">Model</option>
                <option value="serial_number">Serial Number</option>
                <option value="family">Family</option>
            </select>
            <input type="text" name="search_term" id="search" placeholder="Ingrese término de búsqueda">
            <button type="submit">Buscar</button>

        </form>
    </aside>

    <main>
        <div class="container">
            <?php
            foreach ($array as $row) {
                ?>
                <div class="instrument">
                    <h3>
                        <?php
                        echo $row["brand"] . ' ' . $row["model"] . ' - ';
                        $statusColor = ($row["state"] == 'available') ? 'available' : 'lent';
                        echo '<span class="instrument-status ' . $statusColor . '">' . $row["state"] . '</span>';
                        ?>
                    </h3>
                    <img src='.<?php echo $row["image"]; ?>'>
                    <form action="instrument_info.php" method="post">
                        <input type="hidden" name="instrument_id" value="<?php echo $row["id"]; ?>">
                        <button class="showMore" type="submit">+info</button>
                    </form>
                </div>
                <?php
            }
            ?>
        </div>
    </main>

    <footer>
        <p>Información personal - Nombre, dirección, contacto, etc.</p>
    </footer>
</body>

</html>